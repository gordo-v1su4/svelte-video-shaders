---
description: Stack, major dependencies, versions, and best practices for svelte-video-shaders
globs:
alwaysApply: true
---
# Application Stack & Major Dependencies

This rule documents the technology stack, major dependencies, their versions, and best practices for the `svelte-video-shaders` project.

## Core Stack Overview

- **Framework:** SvelteKit (`@sveltejs/kit` ^2.49.1, Svelte ^5.0.0)
- **Package Manager:** Bun 1.3+ (preferred over npm/pnpm)
- **Build Tool:** Vite (^6.2.6)
- **Component Library:** Storybook (^9.0.15) for UI development
- **Shader/3D Engine:** three.js (^0.178.0)
- **Video Decoding:** **WebCodecs API (browser-native)** - **PRIMARY VIDEO PLAYBACK TECHNOLOGY**
- **Video Demuxing:** mp4box (^1.2.0) - **REQUIRED FOR WebCodecs**
- **Frame Buffer:** Custom pre-decoded ImageBitmap arrays for seamless retiming
- **Audio Analysis (Real-time):** Web Audio API FFT (see audio-utils.js)
- **Audio Analysis (Offline):** External Essentia API (https://essentia.v1su4.com) for beat detection, structure analysis, and energy curves
- **Timeline/Waveform:** Custom WaveformDisplay.svelte component
- **UI Controls:** svelte-tweakpane-ui (^1.5.9), tweakpane (^4.0.5)
- **Testing:** Vitest (^4.0.14), vitest-browser-svelte (^2.0.1), @vitest/browser-playwright (^4.0.15)
- **Linting/Formatting:** ESLint (^9.18.0), Prettier (^3.4.2), prettier-plugin-svelte (^3.3.3)
- **CSS:** TailwindCSS (^4.0.0), @tailwindcss/typography (^0.5.15)

## External API (Essentia Audio Analysis)

- **Endpoint**: https://essentia.v1su4.com
- **Repository**: Separate repo at `essentia-endpoint/`
- **Framework:** FastAPI with uvicorn, Essentia C++ core via Python
- **Endpoints:**
  - `POST /analyze/rhythm` - BPM, beats, onsets, confidence, duration, energy curve
  - `POST /analyze/structure` - Sections (intro/verse/chorus/outro) with energy values
  - `POST /analyze/classification` - Genre, mood, tags
  - `POST /analyze/full` - Complete analysis (rhythm + structure + classification)
  - `GET /health` - Health check
- **Documentation:** See `ESSENTIA_API.md`, `API_COMPATIBILITY.md` in project root
- **Configuration:** Set `VITE_ESSENTIA_API_URL` in `.env` file

## Dependency Versions (from [package.json](mdc:package.json))

### Key Dependencies
```json
{
  "@sveltejs/kit": "^2.49.1",
  "svelte": "^5.0.0",
  "three": "^0.178.0",
  "mp4box": "^1.2.0",
  "svelte-tweakpane-ui": "^1.5.9",
  "tweakpane": "^4.0.5",
  "mediabunny": "latest"
}
```

### DevDependencies (selected)
```json
{
  "vite": "^6.2.6",
  "@storybook/sveltekit": "^9.0.15",
  "vitest": "^4.0.14",
  "eslint": "^9.18.0",
  "prettier": "^3.4.2",
  "tailwindcss": "^4.0.0"
}
```

## Best Practices & Remarks

### SvelteKit & Svelte 5
- Use Svelte 5 runes syntax and new event handling (see [svelte-5-syntax.mdc](mdc:.cursor/rules/svelte-5-syntax.mdc)).
- Prefer native event attributes (e.g., `onclick`) and runes for state/props.
- SvelteKit 2.x is stable, but breaking changes may occur on major upgrades—test thoroughly after upgrades.

### three.js
- Use direct three.js integration for video textures and shaders ("bare metal" approach is preferred over wrappers like Threlte for stability and control).
- Use `OrthographicCamera` for 2D video planes (see [GEMINI.md](mdc:docs/GEMINI.md)).
- Always dispose of Three.js resources and close VideoFrames to avoid memory leaks.

### WebCodecs & mp4box
- **WebCodecs is the PRIMARY video playback technology** - all new video features should use WebCodecs first.
- Use WebCodecs API for video decoding; fallback to HTML5 `<video>` if unsupported.
- Use mp4box for MP4 demuxing and feeding encoded chunks to WebCodecs.
- Always call `frame.close()` after using a VideoFrame.
- Test in Chrome 94+, Edge 94+, Safari 16.4+ for compatibility.
- **Transition Goal:** Replace all HTML5 `<video>` usage with WebCodecs + three.js for shader effects.

### ffmpeg.wasm
- **Use only for complex video processing** (e.g., export, transcoding, thumbnails if WebCodecs is unavailable).
- **NOT for primary video playback** - WebCodecs handles all real-time video decoding.
- Run ffmpeg.wasm in a Web Worker to avoid blocking the UI (see [research-changes.md](mdc:docs/research-changes.md)).
- Use CDN for ffmpeg-core WASM assets for best performance.
- **Transition Goal:** Minimize ffmpeg.wasm usage to only complex processing tasks.

### svelte-tweakpane-ui & tweakpane
- Use for real-time shader/UI parameter tweaking.
- Keep filter parameters in `$state` and update shader uniforms reactively.

### TailwindCSS
- Use for utility-first styling; keep custom CSS minimal.
- Use @tailwindcss/typography for rich text content.

### Storybook
- Use for component-driven development and visual testing.
- Keep stories in `src/stories/` and assets in `src/stories/assets/`.

### Vitest
- Use Vitest 4.0+ for unit and browser-based testing.
- **Browser Mode:** Vitest 4 uses stable browser mode (no longer experimental).
- Use `vitest-browser-svelte` v2.0+ for Svelte component tests in browser mode.
- **Configuration:**
  - Use `browser.enabled: true` (do NOT set `environment: 'browser'` in Vitest 4).
  - Provider must be a factory function: `provider: playwright()` from `@vitest/browser-playwright`.
  - Import `page` from `vitest/browser` (not `@vitest/browser/context`).
  - Browser matchers available via `@vitest/browser/matchers` (import in setup file or test files).
  - Setup file should include reference types: `/// <reference types="vitest/browser/matchers" />`
- **Test Projects:** Use separate projects for browser (`browser.enabled: true`) and node (`environment: 'node'`) tests.
- **Breaking Changes from Vitest 3:**
  - `environment: 'browser'` removed - use `browser.enabled: true` instead.
  - `provider: 'playwright'` (string) → `provider: playwright()` (factory function).
  - `@vitest/browser/context` → `vitest/browser` for page import.
  - `expect.element()` removed - use standard `expect()` with browser matchers.
- Browser tests require Playwright browsers: `bunx playwright install`.

### Linting & Formatting
- Use ESLint and Prettier with Svelte and Tailwind plugins for consistent code style.
- Run `bun run lint` and `bun run format` before commits.

### Frame Buffer System
- Pre-decode all videos into ImageBitmap arrays on load for instant random access
- Enables seamless speed ramps, jump cuts, and retiming without decode latency
- Fixed output dimensions (1920x1080) for consistent texture handling
- Progress callback during preloading for UI feedback

### Beat Detection & Audio Analysis Pipeline
- **Real-time FFT** runs in browser via Web Audio API (audioLevel, bassLevel, midLevel, trebleLevel)
- **Offline analysis** via external Essentia API at https://essentia.v1su4.com
  - Rhythm: BPM, beats, onsets, confidence, duration
  - Energy: High-resolution RMS curve (~86Hz) for speed ramping
  - Structure: Section segmentation with energy values for glitch mode
  - Classification: Genre, mood, tags (optional)
- **Local development:** Use external API or run local instance from `essentia-endpoint/` repo
- **Configuration:** `VITE_ESSENTIA_API_URL=https://essentia.v1su4.com` in `.env`

### General
- **Bun:** Use `bun install`, `bun run dev`, etc. instead of npm/pnpm
- **WebCodecs First:** Always implement new video features using WebCodecs + three.js first.
- Use COEP/COOP headers in Vite dev server for SharedArrayBuffer/WebCodecs support.
- Keep dependencies up to date, but pin versions to avoid breaking changes.

## Example: Good Import Patterns
```typescript
// ✅ Good: Direct three.js import
import * as THREE from 'three';

// ✅ Good: SvelteKit $lib import
import ShaderPlayer from '$lib/ShaderPlayer.svelte';

// ✅ Good: WebCodecs usage (PRIMARY video technology)
const decoder = new VideoDecoder({ ... });

// ✅ Good: mp4box demuxing (REQUIRED for WebCodecs)
import * as MP4Box from 'mp4box';

// ✅ Good: Vite-compatible mp4box import
import { default as MP4BoxModule } from 'mp4box';

// ✅ Good: Vitest 4 browser mode imports
import { page } from 'vitest/browser';
import { playwright } from '@vitest/browser-playwright';
import '@vitest/browser/matchers'; // For browser matchers (toBeInTheDocument, etc.)
```

## References
- [PLAN.md](mdc:docs/PLAN.md)
- [research-changes.md](mdc:docs/research-changes.md)
- [GEMINI.md](mdc:docs/GEMINI.md)
- [svelte-5-syntax.mdc](mdc:.cursor/rules/svelte-5-syntax.mdc)
