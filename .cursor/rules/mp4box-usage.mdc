---
description: mp4box.js integration patterns for MP4 demuxing with WebCodecs
globs: **/*.{js,svelte}
alwaysApply: false
---
# mp4box.js Integration and Usage Rule

This rule documents the correct way to integrate and use [mp4box.js](https://github.com/gpac/mp4box.js) for MP4 demuxing in the Svelte Video Shaders project, ensuring compatibility with SvelteKit, WebCodecs, and Three.js.

## Why mp4box.js?
- **Demuxes MP4 containers** to extract video samples for decoding with WebCodecs
- Required for frame-accurate, real-time video playback and shader effects
- Works in browsers and with modern build tools (Vite)

## Vite Configuration (Required)

**Critical:** mp4box must be excluded from Vite's dependency optimization:

```javascript
// vite.config.js
export default defineConfig({
  optimizeDeps: {
    exclude: ['mp4box'] // Prevent Vite from pre-bundling (required for ESM compatibility)
  },
  // ... rest of config
});
```

**Why?** mp4box uses ESM and requires raw module loading. Vite's pre-bundling can cause resolution errors or HMR issues.

## Import Pattern

**Always use the Vite-compatible import:**
```javascript
// ✅ Good: Vite-compatible import
import { default as MP4BoxModule } from 'mp4box';

// ✅ Alternative: namespace import
import * as MP4Box from 'mp4box';
```
**Never use direct default import without curly braces:**
```javascript
// ❌ Bad: This may fail in Vite
import MP4Box from 'mp4box';
```

## Setup and Usage

1. **Create the MP4Box file instance:**
   ```javascript
   const mp4boxfile = MP4BoxModule.createFile();
   ```
2. **Set up event handlers:**
   - `onReady`: Configure the WebCodecs VideoDecoder using track info
   - `onSamples`: Feed extracted samples to the decoder
   ```javascript
   mp4boxfile.onReady = (info) => {
     // ✅ Correct: Use info.tracks.find() to get video track
     const videoTrack = info.tracks.find(t => t.type === 'video');
     if (!videoTrack) {
       console.error('No video track found');
       return;
     }
     
     if (VideoDecoder.isConfigSupported(videoTrack.codec)) {
       videoDecoder.configure({
         codec: videoTrack.codec,
         codedWidth: videoTrack.video?.width || videoTrack.track_width,
         codedHeight: videoTrack.video?.height || videoTrack.track_height
       });
       mp4boxfile.setExtractionOptions(videoTrack.id, null, { nbSamples: 100 });
       mp4boxfile.start();
     }
   };

   mp4boxfile.onSamples = (track_id, ref, samples) => {
     for (const sample of samples) {
       const type = sample.is_sync ? 'key' : 'delta';
       const chunk = new EncodedVideoChunk({
         type,
         timestamp: sample.cts,
         duration: sample.duration,
         data: sample.data
       });
       if (videoDecoder.state === 'configured') {
         videoDecoder.decode(chunk);
       }
     }
   };
   ```
3. **Feed data to mp4box.js:**
   - Use streaming fetch and append buffers with correct `fileStart` offsets
   ```javascript
   const response = await fetch(src);
   const reader = response.body.getReader();
   let offset = 0;
   while (true) {
     const { done, value } = await reader.read();
     if (done) {
       mp4boxfile.flush();
       break;
     }
     const buffer = value.buffer;
     buffer.fileStart = offset;
     offset += buffer.byteLength;
     mp4boxfile.appendBuffer(buffer);
   }
   ```

## Best Practices
- **Always check codec support** with `VideoDecoder.isConfigSupported()` before configuring
- **Use `info.tracks.find()`** instead of `info.videoTracks[0]` for track access (more reliable)
- **Buffer enough samples** (e.g., `nbSamples: 100`) for smooth playback
- **Properly clean up**: call `mp4boxfile.stop()` and release resources on component destroy
- **Exclude from Vite optimizeDeps**: Add `mp4box` to `optimizeDeps.exclude` in vite.config.js
- **Reference:** See [webcodecs-frame-buffer.js](mdc:src/lib/webcodecs-frame-buffer.js) for a full implementation

## Good Example
```javascript
import { default as MP4BoxModule } from 'mp4box';
const mp4boxfile = MP4BoxModule.createFile();
mp4boxfile.onReady = (info) => { /* ... */ };
mp4boxfile.onSamples = (track_id, ref, samples) => { /* ... */ };
// ...fetch and appendBuffer as above
```

## Bad Example
```javascript
import MP4Box from 'mp4box'; // ❌ Not Vite-compatible

// ❌ Bad: Using info.videoTracks[0] (may not exist)
mp4boxfile.onReady = (info) => {
  const track = info.videoTracks[0]; // May be undefined
  // ...
};

// ❌ Bad: Missing Vite optimizeDeps exclusion
// vite.config.js without optimizeDeps.exclude: ['mp4box']
```

## References
- [mp4box.js GitHub](https://github.com/gpac/mp4box.js)
- [ShaderPlayer.svelte](mdc:src/lib/ShaderPlayer.svelte)
- [WebCodecs API Best Practices](mdc:.cursor/rules/webcodecs-api.mdc)
